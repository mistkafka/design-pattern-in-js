<!DOCTYPE html>
<html lang="zh_CN">

<head>
    <meta charset="utf-8" />
    <title>职责链模式</title>
</head>

<body>
    <section>
        <h1>反例：商场优惠劵</h1>
        <p>分析下需求就会知道，确定优惠政策有两个因素：</p>
        <ol>
            <li>用户是否已经付了定金</li>
            <li>用户的订单类型</li>
        </ol>
        <p>这里不去考虑库存问题，从书里的例子来看，优惠政策跟库存无关。</p>
        <p>那么第一版反例是这样的，把if-else都放在一个函数里</p>
        <a href="./discounts.js" target="_blank">源码</a>
        <div>
            <iframe src="./discounts.js"></iframe>
        </div>
    </section>

    <section>
        <h1>职责链模式版：商场优惠劵</h1>
        <p>实际上，职责链就是把每一种if-else，也就是“决策”拆分到各个“决策函数”当中，每个“决策函数”自己负责该不该被“采用”。我们把这些“决策函数”逐一执行，直到遇到第一个可以被采用的“决策函数”，我们就采用它。</p>
        <a href="./discounts-with-chain-of-responsibility-pattern.js">源码</a>
        <div>
            <iframe src="./discounts-with-chain-of-responsibility-pattern.js"></iframe>
        </div>

        <p>可以看到，现在我们如果要新增一种“优惠”，只需要写好它的“决策函数”，并且在“恰当的位置”（这个后面会讨论）的插入它就可以了。如果要删除某种优惠，直接在那个数组里把它移走就行了。</p>

        <p>本例子中几乎每一个策略函数里都对两个“因素”做了判断，以此决定是不是应该采纳本“决策”。我觉得显示的把因素限定住是个最佳实践，因为这样比较严谨，条件限定得很“死”也很安全。如果“因素”非常之多，可以用一个“因素表”来取代if语句里面的条件语句，这样也会清晰很多。</p>

        <p>坑点一：千万注意“决策函数”在数组里的顺序。前面提到“恰当的位置”，它指的是“写这段逻辑代码的你要清楚不同'决策'之间的优先级，按照该有的优先级排列决策函数”。老实讲，用原来的那种if-else也同样有可能搞错了决策之间的顺序。</p>

        <p>坑点二：加了“因素”之后特别要注意有些函数是不是没有考虑新增的因素？导致条件覆盖错了。</p>
    </section>

    <section>
      <h1>职责链模式+策略模式版：计算奖金</h1>

      <p>职责链与策略模式是什么关系？我个人的理解，职责链是用来做“决策”的，即采用哪个策略？而策略模式则是用来封装不同策略的具体执行行为。一个是封装“决策”，另一个是封装“执行”。这也是我学习“策略模式”时的困惑。就拿书中那个“计算奖金”的例子，经过“策略模式”改造后的源码在p76页，它是这样写的：<code>console.log(calculateBouns('S', 20000))</code>。这里不能令我满意的是，写这段逻辑的人要自己去判断20000的销售额度与奖金评级'S'的关系，这个“if-else”是藏在我们心里的，并没有被“清理”掉。现在，有了职责链模式，这个“if-else”就可以被清除了</p>
      
      <a href="./calculate-bonus_v2.js">源码</a>
      <div>
        <iframe src="./calculate-bonus_v2.js"></iframe>
      </div>
    </section>
</body>

</html>
